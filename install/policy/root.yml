---
- !user mark

- !user darren

- !user amy

- !group admins

- !group auditors

- !grant
  role: !group admins
  members:
    - !user mark
    - !user darren

- !permit
  role: !group admins
  privileges:
    - create
    - update
    - read
  resources:
    - !policy root

- !grant
  role: !group auditors
  members:
    - !user amy

- !permit
  role: !group auditors
  privileges:
    - read
  resources:
    - !policy root

- !policy
  id: apps
  owner: !group admins

- !policy
  id: conjur
  body:
    - !policy 
      id: authn-k8s/prod
      body:
        - !webservice
        
        - !variable ca/key
        
        - !variable ca/cert

        - !policy
          id: apps
          body:
          - !layer

          - &authenticated-resources-k8s
            - !host
              id: dap/service_account/conjur-cluster
              annotations:
                kubernetes/authentication-container-name: authenticator
                kubernetes: "true"

            - !host
              id: demoapps/deployment/jenkins
              annotations:
                kubernetes/authentication-container-name: authenticator
                kubernetes: "true"

          - !grant
            role: !layer
            members: *authenticated-resources-k8s
            
        - !permit
          resource: !webservice
          privilege: [ read, authenticate ]
          role: !layer apps

    - !policy
      id: seed-generation
      body:
      - !webservice
      - !layer consumers
      - !permit
        role: !layer consumers
        privilege: [ "execute" ]
        resource: !webservice

    - !grant
      role: !layer seed-generation/consumers
      member: !host /conjur/authn-k8s/prod/apps/dap/service_account/conjur-cluster